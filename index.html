<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WabTech - Home</title>
  <link rel="stylesheet" href="style/dashboard.css">
  <style>
    /* small extra styles for index */
    .container { max-width:1100px; margin:20px auto; padding:0 16px; }
    .hero { display:flex; justify-content:space-between; align-items:center; gap:20px; }
    .course-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:20px; margin-top:20px; }
    .course-card { background:#fff; padding:16px; border-radius:10px; box-shadow:0 3px 12px rgba(0,0,0,0.06); }
    .course-card h3 { margin:6px 0; }
    .btn { background:#2563eb; color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .topbar { display:flex; justify-content:space-between; align-items:center; background:#2563eb; color:white; padding:14px 20px; }
    .topbar a { color:white; text-decoration:none; margin-left:8px; }
    #lesson-view { display:none; margin-top:20px; }
    .two-col { display:grid; grid-template-columns:1fr 360px; gap:20px; align-items:start; }
    @media(max-width:900px){ .two-col{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px">
      <button id="menuBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.12)">☰</button>
      <h2 style="margin:0">WabTech</h2>
    </div>
    <div>
      <a href="login.html" id="authLink">Login / Register</a>
      <a href="dashboard.html" style="margin-left:12px">Dashboard</a>
    </div>
  </div>

  <div class="container">
    <div class="hero">
      <div>
        <h1>Deployment Course Track</h1>
        <p>Learn Heroku, Firebase, AWS, Docker & CI/CD — AI-powered tutor (mock) included.</p>
      </div>
      <div>
        <button id="enrollBtn" class="btn">Enroll (demo)</button>
      </div>
    </div>

    <div id="catalog">
      <h2>Courses</h2>
      <div class="course-grid" id="courseGrid"></div>
    </div>

    <!-- Lesson View -->
    <div id="lesson-view">
      <button id="backToCatalog" class="btn" style="background:#e5e7eb;color:#111;margin-bottom:12px">← Back</button>
      <div id="lesson-title" style="font-size:20px;font-weight:600"></div>
      <div class="two-col" style="margin-top:12px">
        <div>
          <div class="video-container" style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:8px;">
            <iframe id="lessonVideo" src="" frameborder="0" allowfullscreen style="position:absolute;top:0;left:0;width:100%;height:100%"></iframe>
          </div>

          <div id="lessonQuizArea" style="margin-top:16px"></div>
        </div>

        <!-- Right column: AI panel and lesson actions -->
        <div>
          <div class="ai-panel" style="margin-bottom:16px">
            <h3 style="margin-top:0">AI Assistant (mock)</h3>
            <div id="aiLog" style="height:140px;background:#f9f9f9;padding:10px;overflow:auto;border-radius:6px;margin-bottom:8px"></div>
            <input id="aiInput" type="text" placeholder="Ask a deployment question..." style="width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;margin-bottom:8px">
            <div style="display:flex;gap:8px">
              <button id="aiAskBtn" class="btn">Ask</button>
              <button id="genNotesBtn" class="btn" style="background:#10b981">Generate Notes</button>
              <button id="downloadNotesBtn" class="btn" style="background:#6b7280">Download Notes</button>
            </div>
          </div>

          <div style="background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.06)">
            <h4 style="margin:6px 0">Lesson Actions</h4>
            <button id="completeLessonBtn" class="btn" style="width:100%;background:#16a34a">Mark Lesson Completed</button>
            <div id="lessonStatus" style="margin-top:8px;color:#374151"></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- jsPDF for certificate -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Firebase and app scripts -->
  <script type="module">
    import { app } from "./firebaseConfig.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-storage.js";

    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Sample static courses (fallback if Firestore empty)
    const sampleCourses = [
      {
        id: 'deploymentCourse',
        title: 'Deployment Course',
        description: 'Heroku, Firebase Hosting, AWS basics, Docker, CI/CD',
        lessons: [
          { id: 'heroku', title: 'Heroku Deployment', video: 'https://www.youtube.com/embed/0yWAtQ6wYNM' },
          { id: 'firebase', title: 'Firebase Hosting', video: 'https://www.youtube.com/embed/9kRgVxULbag' },
          { id: 'aws', title: 'Deploy to AWS (overview)', video: 'https://www.youtube.com/embed/1KJl9V6g6bY' }
        ]
      }
    ];

    // Mock AI knowledge base (20 Q&A) - same as aiTutor
    const knowledge = [
      { keywords: ["heroku","deploy","procfile"], answer: "To deploy on Heroku: create a Procfile (if needed), commit code, then use `git push heroku main` or connect GitHub and enable automatic deploys."},
      { keywords: ["firebase","hosting","deploy"], answer: "To deploy Firebase Hosting: run `firebase init hosting` once, then `firebase deploy` to publish your site."},
      { keywords: ["docker","container","image"], answer: "Docker: write a Dockerfile, `docker build -t name .`, then run locally or push to registry and deploy to cloud."},
      { keywords: ["vercel","nextjs"], answer: "Vercel auto-deploys Next.js apps when you connect your GitHub repo; it handles serverless functions too."},
      { keywords: ["netlify","static"], answer: "Netlify is great for static sites. Connect the repo or drag & drop the build folder to deploy."},
      { keywords: ["aws","ec2","amplify"], answer: "AWS Amplify provides CI/CD for web apps, EC2 is raw VM hosting—Amplify is simpler for front-end deployments."},
      { keywords: ["ci","cd","pipeline"], answer: "CI/CD automates build+test+deploy. Use GitHub Actions to run tests and deploy to Firebase or Heroku."},
      { keywords: ["ssl","https","certificate"], answer: "Firebase Hosting and Vercel provide free SSL automatically; custom domains need DNS setup."},
      { keywords: ["custom domain","dns"], answer: "Add your domain in hosting provider and update DNS records (A/CNAME) to point to your host."},
      { keywords: ["env","variables","config"], answer: "Set environment variables in Heroku under Settings > Config Vars, or use Firebase Functions config for server-side variables."},
      { keywords: ["logs","debug","error"], answer: "Check logs: Heroku `heroku logs --tail`, Firebase Functions logs in console or `firebase functions:log`."},
      { keywords: ["node","version"], answer: "Specify Node version in package.json under `engines` to ensure correct runtime (e.g., `\"node\": \"18.x\"`)."},
      { keywords: ["rollback","release"], answer: "Heroku supports releases and rollback (`heroku releases:rollback v123`). Keep track of release history."},
      { keywords: ["billing","cost"], answer: "Use free tiers for development. Monitor usage; cloud costs can increase with traffic or compute."},
      { keywords: ["testing","unit test"], answer: "Run tests in CI before deploy. Use Jest/Mocha for Node apps and run them in GitHub Actions."},
      { keywords: ["cdn","cache"], answer: "Hosting providers use CDNs (Firebase, Vercel) to cache static assets globally for speed."},
      { keywords: ["npm","build","error"], answer: "Ensure `npm run build` works locally and that dependencies are present; check build logs for errors."},
      { keywords: ["dockerhub","push"], answer: "Tag then push: `docker build -t user/app .` then `docker push user/app` after login."},
      { keywords: ["github actions","deploy"], answer: "Create a workflow YAML that triggers on push and runs build+deploy commands to your host."},
      { keywords: ["pipeline","failed"], answer: "Failed pipelines usually mean a test or build error—check the build logs and environment variables."}
    ];

    // UI elements
    const courseGrid = document.getElementById('courseGrid');
    const lessonView = document.getElementById('lesson-view');
    const lessonTitle = document.getElementById('lesson-title');
    const lessonVideo = document.getElementById('lessonVideo');
    const aiLog = document.getElementById('aiLog');
    const aiInput = document.getElementById('aiInput');
    const aiAskBtn = document.getElementById('aiAskBtn');
    const genNotesBtn = document.getElementById('genNotesBtn');
    const downloadNotesBtn = document.getElementById('downloadNotesBtn');
    const lessonQuizArea = document.getElementById('lessonQuizArea');
    const completeLessonBtn = document.getElementById('completeLessonBtn');
    const lessonStatus = document.getElementById('lessonStatus');
    const backToCatalog = document.getElementById('backToCatalog');

    let courses = [];
    let activeCourse = null;
    let activeLesson = null;
    let currentQuiz = [];
    let currentUser = null;
    let currentNotes = '';

    // Load courses from Firestore or fallback
    async function loadCatalog() {
      // try firestore courses collection
      try {
        const qSnap = await getDocs(collection(db, 'courses'));
        if (!qSnap.empty) {
          courses = qSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        } else {
          courses = sampleCourses;
        }
      } catch(e) {
        // fallback
        courses = sampleCourses;
      }
      renderCatalog();
    }

    function renderCatalog() {
      courseGrid.innerHTML = '';
      for (const c of courses) {
        const card = document.createElement('div');
        card.className = 'course-card';
        card.innerHTML = `
          <h3>${c.title}</h3>
          <p style="color:#4b5563">${c.description || ''}</p>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
            <button class="btn" data-course="${c.id}">View Course</button>
            <small style="color:#6b7280">${c.lessons?.length || 0} lessons</small>
          </div>`;
        courseGrid.appendChild(card);
        card.querySelector('button').addEventListener('click', ()=>openCourse(c.id));
      }
    }

    function openCourse(courseId) {
      activeCourse = courses.find(x => x.id === courseId);
      // show course lessons in modal-like area (reusing index page)
      // just auto-open first lesson for demo
      if (!activeCourse) return;
      // show list & let user choose lesson
      const modal = document.createElement('div');
      modal.style.background = '#fff';
      modal.style.padding = '16px';
      modal.style.borderRadius = '8px';
      modal.style.boxShadow = '0 6px 20px rgba(0,0,0,0.08)';
      modal.innerHTML = `<h3>${activeCourse.title}</h3>
        <p>${activeCourse.description || ''}</p>
        <div id="lessonListArea"></div>
        <div style="text-align:right;margin-top:8px"><button id="closeCourseList" class="btn">Close</button></div>`;
      document.querySelector('.container').appendChild(modal);
      const listArea = modal.querySelector('#lessonListArea');
      activeCourse.lessons.forEach((ls, idx) => {
        const el = document.createElement('div');
        el.style.padding='8px';
        el.style.borderBottom='1px solid #f1f5f9';
        el.innerHTML = `<strong>${idx+1}. ${ls.title}</strong>
          <div style="margin-top:6px"><button class="btn" data-lesson="${ls.id}">Open Lesson</button></div>`;
        listArea.appendChild(el);
        el.querySelector('button').addEventListener('click', ()=>{
          modal.remove();
          openLesson(activeCourse.id, ls.id);
        });
      });
      modal.querySelector('#closeCourseList').addEventListener('click', ()=>modal.remove());
    }

    function openLesson(courseId, lessonId) {
      const course = courses.find(c=>c.id===courseId);
      const lesson = course.lessons.find(l=>l.id===lessonId);
      activeLesson = { courseId, lessonId, course, lesson };
      lessonTitle.innerText = `${course.title} — ${lesson.title}`;
      lessonVideo.src = lesson.video;
      lessonView.style.display = 'block';
      document.getElementById('catalog').style.display = 'none';
      loadLessonQuiz(courseId, lessonId);
      loadLessonStatus();
      aiLog.innerHTML = '';
      currentNotes = '';
    }

    backToCatalog.addEventListener('click', ()=>{
      lessonView.style.display = 'none';
      document.getElementById('catalog').style.display = 'block';
      lessonVideo.src = '';
    });

    // Simple keyword-based mock AI
    function mockAi(question) {
      const q = question.toLowerCase();
      for (const item of knowledge) {
        if (item.keywords.some(k => q.includes(k))) return item.answer;
      }
      return "I don't have an exact answer for that. Try checking the related course or ask the AI Tutor in the Dashboard.";
    }

    aiAskBtn.addEventListener('click', ()=>{
      const q = aiInput.value.trim();
      if (!q) return;
      aiLog.innerHTML += `<div style="margin-bottom:8px"><b>You:</b> ${q}</div>`;
      const ans = mockAi(q);
      aiLog.innerHTML += `<div style="margin-bottom:8px"><b>WabTech AI:</b> ${ans}</div>`;
      aiLog.scrollTop = aiLog.scrollHeight;
      currentNotes += `Q: ${q}\nA: ${ans}\n\n`;
      aiInput.value = '';
    });

    genNotesBtn.addEventListener('click', ()=>{
      if (!currentNotes) {
        alert('No AI conversation to make notes from yet.');
        return;
      }
      alert('Notes generated (stored temporarily). Use "Download Notes" to save locally.');
    });

    downloadNotesBtn.addEventListener('click', ()=>{
      if (!currentNotes) { alert('No notes yet'); return; }
      const blob = new Blob([currentNotes], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `WabTech_Notes_${Date.now()}.txt`;
      a.click();
    });

    // Quiz: simple load from Firestore under courses/{courseId}/lessons/{lessonId}/quiz
    async function loadLessonQuiz(courseId, lessonId) {
      lessonQuizArea.innerHTML = '<h3>Lesson Quiz</h3><div id="quizContainer">Loading quiz...</div>';
      try {
        const quizCol = collection(db, `courses/${courseId}/lessons/${lessonId}/quiz`);
        const snap = await getDocs(quizCol);
        const quiz = snap.docs.map(d=>({ id: d.id, ...d.data() }));
        if (!quiz.length) {
          document.getElementById('quizContainer').innerHTML = '<p>No quiz for this lesson.</p>';
          currentQuiz = [];
          return;
        }
        currentQuiz = quiz;
        renderQuizQuestion(0);
      } catch(e) {
        // fallback: no quiz in DB
        document.getElementById('quizContainer').innerHTML = '<p>No quiz defined in Firestore for this lesson.</p>';
        currentQuiz = [];
      }
    }

    let quizIndex = 0;
    function renderQuizQuestion(idx) {
      quizIndex = idx;
      const q = currentQuiz[idx];
      if (!q) return;
      const container = document.getElementById('quizContainer');
      let html = `<p><b>Q${idx+1}:</b> ${q.question}</p>`;
      q.options.forEach((opt,i)=>{
        html += `<label style="display:block;margin:6px 0"><input name="quizOpt" type="radio" value="${i}"> ${opt}</label>`;
      });
      html += `<div style="margin-top:10px"><button id="submitQuizBtn" class="btn">Submit Answer</button></div>`;
      container.innerHTML = html;
      document.getElementById('submitQuizBtn').addEventListener('click', submitQuizAnswer);
    }

    async function submitQuizAnswer() {
      const sel = document.querySelector('input[name="quizOpt"]:checked');
      if (!sel) { alert('Choose an answer'); return; }
      const chosen = parseInt(sel.value,10);
      const q = currentQuiz[quizIndex];
      const correct = q.answer; // in Firestore we store answer as index or string - handle both
      const isCorrect = (typeof correct === 'number') ? (chosen === correct) : (q.options[chosen] === correct);
      const quizContainer = document.getElementById('quizContainer');
      quizContainer.innerHTML += `<p style="color:${isCorrect? '#059669':'#dc2626'}">${isCorrect? 'Correct!':'Incorrect.'}</p>`;

      // store quiz result into Firestore at users/{uid}/enrolledCourses/{courseId}.lessons.{lessonId}
      const user = auth.currentUser;
      if (!user) {
        quizContainer.innerHTML += `<p style="color:#6b7280">Login to save results.</p>`;
        return;
      }

      // update user's completed lessons only if passed
      if (isCorrect) {
        try {
          const userCourseRef = doc(db, `users/${user.uid}/enrolledCourses/${activeCourse.id}`);
          // merge set: lessons.{lessonId}: { completed: true, quizScore: 1 }
          await setDoc(userCourseRef, { lessons: { [activeLesson.lessonId]: { completed: true, quizScore: 1 } } }, { merge: true });
          // update progress number in same doc (we'll compute on dashboard)
          quizContainer.innerHTML += `<p style="color:#059669">Saved result and marked lesson complete.</p>`;
          await updateCourseProgressUI(user.uid, activeCourse.id);
        } catch(e) {
          console.error(e);
        }
      } else {
        // save quizScore 0
        const user = auth.currentUser;
        if (user) {
          const userCourseRef = doc(db, `users/${user.uid}/enrolledCourses/${activeCourse.id}`);
          await setDoc(userCourseRef, { lessons: { [activeLesson.lessonId]: { completed: false, quizScore: 0 } } }, { merge: true });
        }
      }

      // advance to next question or finish
      if (quizIndex + 1 < currentQuiz.length) {
        setTimeout(()=> renderQuizQuestion(quizIndex+1), 700);
      } else {
        quizContainer.innerHTML += `<p style="margin-top:8px">Quiz finished.</p>`;
      }
    }

    async function updateCourseProgressUI(userId, courseId) {
      // fetch user's enrolledCourse doc and calculate percent
      const ref = doc(db, `users/${userId}/enrolledCourses/${courseId}`);
      const snap = await getDoc(ref);
      const total = activeCourse.lessons.length;
      let completed = 0;
      if (snap.exists()) {
        const data = snap.data();
        if (data.lessons) {
          completed = Object.values(data.lessons).filter(x => x.completed).length;
        }
      }
      const percent = Math.round((completed / total) * 100);
      // Save percent
      await setDoc(ref, { progress: percent, title: activeCourse.title }, { merge: true });
      lessonStatus.innerText = `Progress for this course: ${percent}%`;
      // if 100% generate certificate
      if (percent === 100) {
        await generateAndUploadCertificate(userId, courseId, auth.currentUser.displayName || auth.currentUser.email, activeCourse.title);
      }
    }

    // Mark lesson button (manual)
    completeLessonBtn.addEventListener('click', async ()=>{
      const user = auth.currentUser;
      if (!user) { alert('Login to mark completed'); return; }
      const userCourseRef = doc(db, `users/${user.uid}/enrolledCourses/${activeCourse.id}`);
      await setDoc(userCourseRef, { lessons: { [activeLesson.lessonId]: { completed: true, quizScore: null } } }, { merge: true });
      await updateCourseProgressUI(user.uid, activeCourse.id);
      alert('Lesson marked completed')
